<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Programming blog">

        <meta name="googlebot" content="noindex, nofollow" />
        <meta name="Googlebot-Mobile" content="noindex, nofollow" />
        <meta name="Baiduspider" content="noindex, nofollow" />
        <meta name="Sogou web spider" content="noindex, nofollow" />

        <title>gyk-notes - Flink数据延迟分析</title>
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400italic,600italic,700italic,400,600,700" rel="stylesheet" type="text/css" />
        <link rel="stylesheet" type="text/css" href="../../../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../../../css/syntax.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../../../">gyk-notes</a>
            </div>
            <div id="navigation">
                <a href="../../../">Home</a>
                <a href="../../../about.html">About</a>
                <a href="../../../contact.html">Contact</a>
                <a href="../../../archive.html">Archive</a>
            </div>
        </div>
        <div class="sep-line"></div>
        <div id="content">
            <h1>Flink数据延迟分析</h1>
            <div class="info">
    Posted on October 20, 2016
    
</div>
<div class="info">
    
    Tags: <a title="All pages tagged 'Code'." href="../../../tags/Code.html">Code</a>
    
</div>

<h2 id="问题">问题</h2>
<p>基于 Flink 的日志收集服务（从 Kafka 消费日志，写入 Elasticsearch）延迟过高，部分日志数据丢失。</p>
<h2 id="分析">分析</h2>
<p>主要原因有两点：</p>
<ol type="1">
<li>Elasticsearch 性能不满足要求</li>
<li>Kafka 中收集的日志时间戳异常</li>
</ol>
<hr />
<h3 id="elasticsearch-性能问题">Elasticsearch 性能问题</h3>
<p>参考 <a href="https://github.com/elastic/elasticsearch/issues/16676">Elasticsearch Issue #16676: Slow performance on HDD</a></p>
<p>从 Elasticsearch 2.0 开始，默认设置下会在每次索引请求之后调用 <code>fsync</code> 做磁盘同步，导致在 HDD 上的性能非常糟糕。</p>
<ul>
<li><p>同样使用 single API，<code>index.translog.durability</code> 设置为 <code>request</code>（默认值），单机，1个 replica 的情况下的测试结果：</p>
<ul>
<li>WD5000AZLX： 15 条/秒 （运行 <code>iostat</code> 可以观察到磁盘利用率已经饱和）</li>
<li>SSD (RMBP, Early 2015)： 1400+ 条/秒</li>
</ul></li>
<li><p>修改设置 <code>index.translog.durability: async</code> 以后：</p>
<ul>
<li>WD5000AZLX： 6200 条/秒</li>
<li>WD4000FYYZ： 7000+ 条/秒</li>
</ul></li>
</ul>
<p>一旦 ES 性能不足，新发起的索引将引发 <code>EsRejectedExecutionException</code> 异常。 Flink 的 <code>ElasticsearchSink</code> 使用 ES <code>BulkProcessor</code> 提供的批量索引 API，缺省情况下的退避策略是 <code>BackoffPolicy#exponentialBackoff</code>，所以在累计8次重试失败后放弃本次 bulk API 请求造成数据丢失。这时候可以从 Flink Web UI 看到 backpressure 很高。</p>
<p>目前数据分析计算模块中的 <code>node_name</code> 和 <code>node_room</code> 两个指标会产生较多的索引请求。每个时间窗结束后输出结果大约有几百至上千行不等。根据实测结果，当时间窗 = 5s 时，把 Flink Elasticsearch Connector 的 <code>bulk.flush.max.actions</code> 设置到10000以上勉强可满足负载。但是这无法扩展至更多的分析维度和更小的时间粒度。</p>
<p>因此必须使用 <code>index.translog.durability: async</code> 参数，除非更换成 SSD 存储。如此设置的缺点是万一发生硬件故障，未同步的数据将全部丢失。</p>
<p><br /> 其它 ES 的优化（未测试）</p>
<ul>
<li><code>index.number_of_replicas: 0</code> 现有的 ES 集群就是这么设置，没有使用副本</li>
<li><code>index.merge.scheduler.max_thread_count: 1</code> 适合 HDD</li>
<li><code>bootstrap.mlockall: true</code> 避免内存交换</li>
<li><code>indices.memory.index_buffer_size: 50%</code> 优化 write heavy 集群</li>
<li>增加 <code>index.refresh_interval</code></li>
<li>增大 bulk API 的线程池大小，相应减少其它 API 的线程池大小</li>
</ul>
<hr />
<h3 id="日志时间戳异常">日志时间戳异常</h3>
<p>Flink 按照 Google Dataflow 模型实现了 Watermark 机制，本身容许一定的消息乱序。</p>
<ul>
<li>如果消息延迟的上限能够确定，可以使用 Flink 自带的 <code>BoundedOutOfOrdernessTimestampExtractor</code>类似的策略（滞后更新 watermark，保留一定余度）丢弃少量阈值外的消息。</li>
<li>如果不确定，单纯延后 watermark 生成并不是很好的方案：
<ul>
<li>内存中滞留的时间窗太多会带来性能问题。虽然 <code>reduce</code> 和 <code>fold</code> 操作是增量式的，但是状态变量包含一个巨大的 <code>map</code> 。</li>
<li>这本身也违背实时数据处理的原则。</li>
</ul></li>
</ul>
<p>注意：<a href="https://issues.apache.org/jira/browse/FLINK-3714">FLINK-3714</a>（合并进 Flink 1.1.0） 中的 patch 对 <code>WindowOperator</code> 加入了一个 <code>allowedLateness</code> 字段，因此新版本对于延迟消息有不一样的行为。</p>
<ul>
<li><p>原有的延迟消息策略</p>
<p>对<strong>单条</strong>延迟消息应用时间窗口函数并马上传递到流处理管线的下游（如果有多条连续的延迟消息，不会合并成单个时间窗口，而是产生许多独立的时间窗口）。</p>
<p>这一点可以从 <code>EventTimeTrigger</code> 的代码得出：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="at">@Override</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">public</span> TriggerResult <span class="fu">onElement</span>(<span class="bu">Object</span> element, <span class="dt">long</span> timestamp, TimeWindow window, TriggerContext ctx) <span class="kw">throws</span> <span class="bu">Exception</span> {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>    <span class="kw">if</span> (window.<span class="fu">maxTimestamp</span>() &lt;= ctx.<span class="fu">getCurrentWatermark</span>()) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>        <span class="co">// if the watermark is already past the window fire immediately</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>        <span class="kw">return</span> TriggerResult.<span class="fu">FIRE</span>;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>    } <span class="kw">else</span> {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>        ctx.<span class="fu">registerEventTimeTimer</span>(window.<span class="fu">maxTimestamp</span>());</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>        <span class="kw">return</span> TriggerResult.<span class="fu">CONTINUE</span>;</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>    }</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>}</span></code></pre></div>
<p>对于延迟消息，“小于当前 watermark”的判断始终为真，所以会立即激发窗口函数，在逻辑上相当于划分到独立的时间窗。</p></li>
<li><p>更新后的延迟策略</p>
<p>直接丢弃延迟时间超过 <code>allowedLateness</code> 的消息，见 <a href="https://github.com/apache/flink/blob/release-1.1/flink-streaming-java/src/main/java/org/apache/flink/streaming/runtime/operators/windowing/WindowOperator.java"><code>WindowOperator.java</code></a> ：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">for</span> (W window: elementWindows) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>    <span class="co">// check if the window is already inactive</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>    <span class="kw">if</span> (<span class="fu">isLate</span>(window)) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>        LOG.<span class="fu">info</span>(<span class="st">&quot;Dropped element &quot;</span> + element + <span class="st">&quot; for window &quot;</span> + window + <span class="st">&quot; due to lateness.&quot;</span>);</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>        <span class="kw">continue</span>;</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    }</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>    <span class="co">// ...</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>}</span></code></pre></div>
<p>这里 <code>isLate</code> 的定义为： <code>window.maxTimestamp() + allowedLateness &lt;= currentWatermark</code>。</p></li>
</ul>
<p><br /> 目前看来日志源的延迟无法保证。下面第一张图属于正常的分布情况，只有零星的延迟消息。第二张图有成批的延迟消息，这有可能是日志服务器时间设置错误造成的。这时候较好的做法是像正常消息一样聚集形成时间窗口而非丢弃。</p>
<figure>
<img src="result.png" alt /><figcaption>正常的分布</figcaption>
</figure>
<figure>
<img src="result_new.png" alt /><figcaption>引起延迟的分布</figcaption>
</figure>
<hr />
<p>偶尔还会出现不合理的时间戳超前消息。在旧的延迟策略下这会显著损害性能（非常多的时间窗），新的策略下直接造成日志分析挂起（watermark 推进至未来的时间点）。</p>
<p>以下是在 Flink 1.1.1 集群上遇到超前消息的输出：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:40 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">130</span><span class="fu">}</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:45 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">3443</span><span class="fu">}</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:45 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">563</span><span class="fu">}</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:50 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">9343</span><span class="fu">}</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:50 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;slow&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:50 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">963</span><span class="fu">}</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:55 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4952</span><span class="fu">}</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:55 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;slow&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:39:55 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">883</span><span class="fu">}</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:40:25 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:40:25 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:40:30 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:40:35 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:40:40 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">28</span><span class="fu">}</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:40:45 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">}</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:41:00 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:41:05 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">26</span><span class="fu">}</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:41:10 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:41:25 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">13</span><span class="fu">}</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:41:40 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:41:40 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">28</span><span class="fu">}</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:41:45 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">28</span><span class="fu">}</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:05 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:10 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:10 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:25 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">26</span><span class="fu">}</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:25 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:30 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:35 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:42:55 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:43:00 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:43:05 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">26</span><span class="fu">}</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:10:43:05 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:42:35 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:42:45 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">26</span><span class="fu">}</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:42:45 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">26</span><span class="fu">}</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:42:50 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">26</span><span class="fu">}</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:42:50 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">28</span><span class="fu">}</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:42:55 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">26</span><span class="fu">}</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:42:55 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:00 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:05 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">6</span><span class="fu">}</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:05 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:10 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:10 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;size&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">4</span><span class="fu">}</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:15 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">}</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:20 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">28</span><span class="fu">}</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true"></a><span class="fu">{</span><span class="dt">&quot;timestamp&quot;</span><span class="fu">:</span> <span class="st">&quot;13/Oct/2016:18:43:25 +0800&quot;</span><span class="fu">,</span> <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;error_type&quot;</span><span class="fu">,</span> <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;-&quot;</span><span class="fu">,</span> <span class="dt">&quot;value&quot;</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">}</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true"></a><span class="er">...</span></span></code></pre></div>
<p>任务运行在早上10点，却出现了未来时间（18:43）的消息，导致大部分时间戳正确的日志被丢弃。</p>
<p>目前 Flink 除了丢弃以外没有很好的处理方案。解决办法是：1) 从源头上检查日志生成；2) 自定义 Trigger 实现专门的处理逻辑。</p>

        </div>
        <div id="footer">
            Copyright &copy; 2015 - Yukun Guo -
            Powered by <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.css" integrity="sha384-BdGj8xC2eZkQaxoQ8nSLefg4AV4/AwB3Fj+8SUSo7pnKP6Eoy18liIKTPn9oBYNG" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/katex.min.js" integrity="sha384-JiKN5O8x9Hhs/UE5cT5AAJqieYlOZbGT3CHws/y97o3ty4R7/O5poG9F3JoiOYw1" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.0/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body,);"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KNSY6VRL5Y"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-KNSY6VRL5Y');
    </script>
    </body>
</html>
